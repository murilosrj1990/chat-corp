<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie-edge">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
        <link rel="stylesheet" href="style.css">
        <title>Primeira Página</title>
    </head>
    <body>
        <div id="divUsuario">
            <form id="formUsuario">
                <img id="icon" src="icon.png">
                <p>Chat Speed Service</p>
                <input type="text" name="username" placeholder="Digite aqui seu nickname">
                <button type="submit">Entrar no chat</button>
            </form>
        </div>
        
        <div id="divEspera" hidden>
            <p>Sua posição na fila é: <span id="posicaoNaFila"></span></p>
        </div>
        
        <div id="formChat" hidden>
            <form id="chat">
                    <p id="tituloUsuario"></p>           
                    <div class="messages" ></div>
                    <input type="text" name="message" placeholder="Digite aqui sua mensagem">
                    <button type="submit">Enviar</button>
                    
            </form>
            <audio id="wavBeep">
                <source src="beep-msg.wav" type="audio/wav">
            </audio>
        </div>
        
        <script type="text/javascript">
            var i=0;
            var username="";
            var socket = io('https://chatspeed.herokuapp.com/');
            var informacoes_atendimento;
            const audio = document.getElementById("wavBeep");

            /*
            socket.on('previousMessages', function(messages){
                i=messages.length;
                for(message of messages){
                    renderMessage(message);
                }
                $('.messages').animate({
                
                scrollTop: $('.messages').scroll().height() * i // aqui introduz o numero de px que quer no scroll, neste caso é a altura da propria div, o que faz com que venha para o fim
                }, 100);
            });
            */
            
            socket.on('receivedMessage' , function(message){
                renderMessage(message);
            });

            socket.on('fecharAtendimentoNoCliente',(obj)=>{
                console.log("fechou atendimento");
                //socket.leave();
                $('#formChat').hide();
                $('body').append("<p>Obrigado por usar nosso chat! Volte sempre!</p>");
            });
            
            socket.on('iniciarAtendimento' , function(infoAtendimento){
                informacoes_atendimento=infoAtendimento;
                $('.messages').append('<div class="message">Olá meu nome é <strong>'+ infoAtendimento.nome_atendente+'</strong>, como posso ajudar você hoje?</div>');
                $('#divUsuario').hide();
                $('#divEspera').hide();
                $('#formChat').show();
            });

            socket.on('atualizarPosicaoNaFila', (posicao)=>{
                $('#posicaoNaFila').html(posicao);
            });

            
            function renderMyMessage(message){
                $('.messages').append('<div class="myMessage"><strong>'+ message.author+'</strong>:<br>'+ message.message +'</div><br>');
                $('.messages').animate({
            
                scrollTop: $('.messages').scroll().height() * i // aqui introduz o numero de px que quer no scroll, neste caso é a altura da propria div, o que faz com que venha para o fim
                }, 100);
            };

            function renderMessage(message){
                $('.messages').append('<div class="message"><strong>'+ message.author+'</strong>:<br>'+ message.message +'</div><br>');
                $('.messages').animate({
            
                scrollTop: $('.messages').scroll().height() * i // aqui introduz o numero de px que quer no scroll, neste caso é a altura da propria div, o que faz com que venha para o fim
                }, 100);

                audio.play();
            
            };

            $('#formUsuario').submit(function(event){
                event.preventDefault();
                
                var author = $('input[name=username]').val();
                username=author;
                $('#tituloUsuario').html(`Você está logado como: <strong>${username}</strong>`);
                $('#divEspera').show();                
                $('#divUsuario').hide();
                socket.emit('abrirAtendimento', username);
            });


            $('#chat').submit(function(event){
                event.preventDefault();              
                var message = $('input[name=message]').val();  
                $('input[name=message]').val("");             

                if(username.length && message.length){
                    var messageObject={
                        author: username,
                        message: message,
                        room: informacoes_atendimento.room
                    }
                };
                

                renderMyMessage(messageObject);
                i=i+1;
                console.log(i);
                $('.messages').animate({
                
                scrollTop: $('.messages').scroll().height() * i // aqui introduz o numero de px que quer no scroll, neste caso é a altura da propria div, o que faz com que venha para o fim
                }, 100);

                socket.emit('sendMessage', messageObject);
            })
        </script>
    </body>
</html>


